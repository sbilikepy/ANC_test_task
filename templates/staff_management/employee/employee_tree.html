{% extends "base.html" %}
{% load static %}
{% load employee_filters %}
{% block content %}
  
  <div class="container-fluid custom-container">
    <div class="flex-row">
      <div class="level-container" id="level-7">
        {% for employee in employees|get_by_level:7 %}
          <div class="card" id="employee-{{ employee.id }}">
            <div class="card-body">
              <h5 class="card-title">{{ employee.full_name }}</h5>
              <h6 class="card-subtitle mb-2 text-muted">{{ employee.position.name }}</h6>
              <p class="card-text">
                Level: {{ employee.position.hierarchy_level }}</p>
              <p class="card-text">ðŸ“‹ <a
                  href="{% url 'staff_management:employee-detail' pk=employee.id %}"
                  target="_blank">Get info</a></p>
              <button class="btn btn-primary" data-id="{{ employee.id }}"
                      onclick="loadSubordinates({{ employee.id }}, 7)">Load
                subordinates
              </button>
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="level-container" id="level-6"></div>
      <div class="level-container" id="level-5"></div>
      <div class="level-container" id="level-4"></div>
      <div class="level-container" id="level-3"></div>
      <div class="level-container" id="level-2"></div>
      <div class="level-container" id="level-1"></div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
      function loadSubordinates(employeeId, currentLevel) {
          console.log('Loading subordinates for employee ID:', employeeId);

          $.ajax({
              url: '{% url "staff_management:load-subordinates" %}',
              method: 'GET',
              data: {'employee_id': employeeId},
              success: function (data) {
                  console.log('Received data:', data);

                  var nextLevel = currentLevel - 1;
                  var subordinatesHtml = '';

                  data.subordinates.forEach(function (employee) {
                      subordinatesHtml += '<div class="card" id="employee-' + employee.id + '">' +
                          '<div class="card-body">' +
                          '<h5 class="card-title">' + employee.full_name + '</h5>' +
                          '<h6 class="card-subtitle mb-2 text-muted">' + employee['position__name'] + '</h6>' +
                          '<p class="card-text">Level: ' + employee.position + '</p>' +
                          '<p class="card-text">ðŸ“‹ <a href="/employees/' + employee.id + '/" target="_blank">Get info</a></p>'

                      ;


                      if (nextLevel > 1) {

                          subordinatesHtml += '<button class="btn btn-primary" data-id="' + employee.id + '" onclick="loadSubordinates(' + employee.id + ', ' + nextLevel + ')">Load subordinates</button>';
                      }

                      subordinatesHtml += '</div>' +
                          '</div>';
                  });

                  $('#level-' + nextLevel).html(subordinatesHtml);
                  $('#level-' + currentLevel).find('.card').removeClass('active');
                  $('#employee-' + employeeId).addClass('active');
              },
              error: function (xhr, status, error) {
                  console.error('Error loading subordinates:', error);
              }
          });
      }

      $(document).ready(function () {
          var firstEmployeeId = $('#employee-list .list-group-item').first().data('id');
          loadSubordinates(firstEmployeeId, 7);
      });
  </script>

{% endblock %}